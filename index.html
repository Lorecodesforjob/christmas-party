<script>
    // FIXED: EmailJS Configuration with Enhanced Error Handling
    const EMAIL_CONFIG = {
        SERVICE_ID: "service_hqoc4hk",
        TEMPLATES: {
            VOTE_NOTIFICATION: "template_b7wy21e",
            DECEMBER1_NOTIFICATION: "template_mpmmf3q",
            SECRET_SANTA_ASSIGNMENT: "template_re4g76v"
        },
        PUBLIC_KEY: "2mYwlD1nIrfL1ixbp"
    };

    // Enhanced EmailJS Initialization
    let emailJSInitialized = false;

    function initializeEmailJS() {
        return new Promise((resolve, reject) => {
            // Check if EmailJS is already initialized
            if (emailJSInitialized) {
                resolve(true);
                return;
            }

            // Check if EmailJS library is loaded
            if (typeof emailjs === 'undefined') {
                console.error('âŒ EmailJS SDK not loaded');
                reject(new Error('EmailJS SDK not loaded'));
                return;
            }

            try {
                emailjs.init(EMAIL_CONFIG.PUBLIC_KEY);
                emailJSInitialized = true;
                console.log('âœ… EmailJS initialized successfully');
                resolve(true);
            } catch (error) {
                console.error('âŒ Failed to initialize EmailJS:', error);
                reject(error);
            }
        });
    }

    // Enhanced Email Validation
    function isValidEmail(email) {
        if (!email || typeof email !== 'string') return false;
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email.trim());
    }

    // FIXED: Vote Notification with Better Error Handling
    async function sendVoteNotification() {
        console.log('ðŸ”„ Attempting to send vote notification...');

        try {
            // Ensure EmailJS is initialized
            await initializeEmailJS();
        } catch (error) {
            console.error('âŒ Cannot send vote notification - EmailJS not available');
            updateEmailStatus('Email service not available', false);
            return;
        }

        const templateParams = {
            to_email: 'rosariolore59@gmail.com',
            to_name: 'Party Organizer',
            from_name: gameState.playerName || 'Anonymous Voter',
            voter_email: gameState.playerEmail || 'Not provided',
            vote_date: new Date().toLocaleDateString(),
            total_voters: gameState.submissions.length.toString(),
            preferred_date: getDateLabel(gameState.selectedDate) || 'Not selected',
            preferred_location: getLocationLabel(gameState.selectedLocation) || 'Not selected',
            preferred_duration: getDurationLabel(gameState.selectedDuration) || 'Not selected',
            preferred_attire: getAttireLabel(gameState.selectedAttire) || 'Not selected',
            preferred_activity: getActivityLabel(gameState.selectedActivity) || 'Not selected',
            moonshine_choice: getMoonshineLabel(gameState.moonshineChoice) || 'Not selected',
            total_score: (gameState.gameScore + gameState.quoteScore + gameState.lolQuoteScore + 
                         gameState.songScore + gameState.wordleScore + gameState.pokemonScore).toString(),
            message: 'New vote submitted for the Christmas party!'
        };

        console.log('ðŸ“§ Vote Notification Template Params:', templateParams);

        try {
            const response = await emailjs.send(
                EMAIL_CONFIG.SERVICE_ID, 
                EMAIL_CONFIG.TEMPLATES.VOTE_NOTIFICATION, 
                templateParams
            );
            
            console.log('âœ… SUCCESS! Vote notification sent:', response.status, response.text);
            updateEmailStatus('Notification sent successfully!', true);
        } catch (error) {
            console.error('âŒ FAILED to send vote notification:', error);
            
            // Provide more detailed error information
            if (error.status === 400) {
                console.error('âŒ Bad Request - Check template parameters');
            } else if (error.status === 422) {
                console.error('âŒ Unprocessable Entity - Template validation failed');
            } else if (error.status === 429) {
                console.error('âŒ Rate Limited - Too many requests');
            }
            
            updateEmailStatus('Failed to send notification', false);
        }
    }

    // FIXED: Secret Santa Assignment with Better Error Handling
    async function sendSecretSantaAssignment(playerEmail, playerName, targetPlayerNumber, giftSuggestion) {
        console.log('ðŸŽ Attempting to send Secret Santa assignment...');
        
        // Validate inputs
        if (!playerEmail || !isValidEmail(playerEmail)) {
            console.error('âŒ Invalid email address for Secret Santa:', playerEmail);
            return;
        }
        
        if (!playerName) {
            console.error('âŒ Missing player name for Secret Santa');
            return;
        }

        try {
            // Ensure EmailJS is initialized
            await initializeEmailJS();
        } catch (error) {
            console.error('âŒ Cannot send Secret Santa assignment - EmailJS not available');
            // Store assignment locally for manual sending
            storeLocalAssignment(playerEmail, playerName, targetPlayerNumber, giftSuggestion);
            return;
        }

        const templateParams = {
            to_email: playerEmail,
            to_name: playerName,
            player_number: carouselState.playerNumber.toString(),
            target_player_number: targetPlayerNumber.toString(),
            gift_suggestion: giftSuggestion || "Choose a thoughtful unisex gift within the $20-30 budget!",
            budget: '$20-30',
            rules: 'Unisex gifts only, no gift cards, thoughtful and fun gifts!',
            message: 'Your Secret Santa assignment is here! Get ready to spread some holiday cheer.'
        };

        console.log('ðŸ“§ Final Template Params for EmailJS:', templateParams);

        try {
            const response = await emailjs.send(
                EMAIL_CONFIG.SERVICE_ID, 
                EMAIL_CONFIG.TEMPLATES.SECRET_SANTA_ASSIGNMENT, 
                templateParams
            );
            
            console.log(`âœ… Secret Santa assignment sent to ${playerName} successfully!`);
            console.log('EmailJS Response:', response);
        } catch (error) {
            console.error(`âŒ FAILED to send Secret Santa assignment to ${playerName}:`, error);
            
            // Provide detailed error information
            if (error.status === 400) {
                console.error('âŒ Bad Request - Check template parameters');
            } else if (error.status === 422) {
                console.error('âŒ Unprocessable Entity - Template validation failed');
            }
            
            // Store assignment locally for manual sending
            storeLocalAssignment(playerEmail, playerName, targetPlayerNumber, giftSuggestion);
        }
    }

    // NEW: Store assignments locally when email fails
    function storeLocalAssignment(playerEmail, playerName, targetPlayerNumber, giftSuggestion) {
        const localAssignments = JSON.parse(localStorage.getItem('localSecretSantaAssignments') || '[]');
        
        localAssignments.push({
            playerEmail: playerEmail,
            playerName: playerName,
            playerNumber: carouselState.playerNumber,
            targetPlayerNumber: targetPlayerNumber,
            giftSuggestion: giftSuggestion,
            timestamp: new Date().toISOString()
        });
        
        localStorage.setItem('localSecretSantaAssignments', JSON.stringify(localAssignments));
        console.log(`ðŸ“ Secret Santa assignment stored locally for ${playerName}`);
    }

    // NEW: Function to view locally stored assignments (for admin)
    function viewLocalAssignments() {
        const localAssignments = JSON.parse(localStorage.getItem('localSecretSantaAssignments') || '[]');
        
        if (localAssignments.length === 0) {
            console.log('No locally stored assignments found.');
            return;
        }
        
        console.log('ðŸ“‹ Locally Stored Secret Santa Assignments:');
        localAssignments.forEach((assignment, index) => {
            console.log(`${index + 1}. ${assignment.playerName} (${assignment.playerEmail}) -> Player ${assignment.targetPlayerNumber}`);
        });
        
        // Display in admin panel if available
        const adminStatus = document.getElementById('adminStatus');
        if (adminStatus) {
            adminStatus.innerHTML = `<strong>Local Assignments (${localAssignments.length}):</strong><br>` +
                localAssignments.map(a => 
                    `${a.playerName} â†’ Player ${a.targetPlayerNumber}`
                ).join('<br>');
        }
    }

    // FIXED: December 1st Notifications with Better Error Handling
    async function sendDecember1Notifications() {
        const adminStatus = document.getElementById('adminStatus');
        adminStatus.textContent = 'Sending notifications...';
        adminStatus.style.color = '#ffd166';
        
        try {
            // Ensure EmailJS is initialized
            await initializeEmailJS();
        } catch (error) {
            console.error('âŒ Cannot send December 1st notifications - EmailJS not available');
            adminStatus.textContent = 'Email service not available';
            adminStatus.style.color = '#ff6b6b';
            return;
        }

        const winningDate = calculateWinningDate();
        const partyDetails = getPartyDetailsForEmail();
        
        let emailsSent = 0;
        let totalEmails = 0;
        let failedEmails = [];

        // Count valid emails only
        gameState.submissions.forEach(submission => {
            if (submission.email && isValidEmail(submission.email)) {
                totalEmails++;
            }
        });

        if (totalEmails === 0) {
            adminStatus.textContent = 'No valid email addresses to notify.';
            return;
        }

        console.log(`Starting to send ${totalEmails} December 1st notifications`);

        // Send emails sequentially to avoid rate limiting
        for (let i = 0; i < gameState.submissions.length; i++) {
            const submission = gameState.submissions[i];
            
            // Skip if no valid email
            if (!submission.email || !isValidEmail(submission.email)) {
                console.log(`Skipping ${submission.name} - invalid email`);
                continue;
            }

            try {
                await new Promise(resolve => setTimeout(resolve, 2000)); // 2 second delay
                
                const templateParams = {
                    to_email: submission.email,
                    to_name: submission.name,
                    party_date: winningDate,
                    total_attendees: gameState.submissions.length.toString(),
                    location: partyDetails.location || 'To be announced',
                    duration: partyDetails.duration || 'To be announced', 
                    message: 'The Christmas party date has been decided!'
                };

                console.log(`Sending December 1st notification to ${submission.name}`);
                
                await emailjs.send(
                    EMAIL_CONFIG.SERVICE_ID, 
                    EMAIL_CONFIG.TEMPLATES.DECEMBER1_NOTIFICATION, 
                    templateParams
                );
                
                console.log(`âœ… December 1st notification sent to ${submission.name} successfully!`);
                emailsSent++;
                
                adminStatus.textContent = `Sent ${emailsSent}/${totalEmails} notifications...`;
                
            } catch (error) {
                console.error(`âŒ Failed to send December 1st notification to ${submission.name}:`, error);
                failedEmails.push(submission.name);
            }
        }

        // Final status update
        if (failedEmails.length === 0) {
            adminStatus.textContent = `All ${emailsSent} notifications sent successfully!`;
            adminStatus.style.color = '#4ecdc4';
        } else {
            adminStatus.textContent = `Sent ${emailsSent}/${totalEmails}. Failed: ${failedEmails.join(', ')}`;
            adminStatus.style.color = '#ff6b6b';
        }
    }

    // Update the form submission with better error handling
    async function submitForm() {
        const nameInput = document.getElementById('nameInput');
        const emailInput = document.getElementById('emailInput');
        
        gameState.playerName = nameInput.value.trim();
        gameState.playerEmail = emailInput.value.trim();
        
        if (!gameState.playerName || !gameState.playerEmail) {
            alert('Please fill in both your name and email');
            return;
        }
        
        // Validate email format
        if (!isValidEmail(gameState.playerEmail)) {
            alert('Please enter a valid email address');
            return;
        }
        
        // Generate player ID if not exists
        if (!gameState.playerId) {
            gameState.playerId = 'player_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('playerId', gameState.playerId);
        }
        
        // Save submission
        saveSubmission();
        
        // Show results screen
        showScreen('resultsScreen');
        updateResults();
        
        console.log('ðŸ“§ Starting email sequence...');
        
        try {
            // Try to initialize EmailJS
            await initializeEmailJS();
            
            // Send notifications with delays
            setTimeout(() => {
                sendVoteNotification();
            }, 1000);
            
            setTimeout(() => {
                console.log('ðŸŽ Sending Secret Santa assignment...');
                sendSecretSantaAssignment(
                    gameState.playerEmail,
                    gameState.playerName,
                    carouselState.targetPlayerNumber,
                    carouselState.giftSuggestion
                );
            }, 4000);
            
        } catch (error) {
            console.log('ðŸ“§ EmailJS not available - storing assignments locally');
            storeLocalAssignment(
                gameState.playerEmail,
                gameState.playerName,
                carouselState.targetPlayerNumber,
                carouselState.giftSuggestion
            );
        }
        
        // Show local confirmation
        sendEmailNotification();
    }

    // Add local assignments viewer to admin panel
    function addLocalAssignmentsViewer() {
        const adminSection = document.getElementById('adminSection');
        if (adminSection) {
            const viewLocalBtn = document.createElement('button');
            viewLocalBtn.className = 'btn btn-admin';
            viewLocalBtn.textContent = 'View Local Assignments';
            viewLocalBtn.onclick = viewLocalAssignments;
            
            const secretSantaAdmin = adminSection.querySelector('.secret-santa-admin .admin-controls');
            if (secretSantaAdmin) {
                secretSantaAdmin.appendChild(viewLocalBtn);
            }
        }
    }

    // Initialize the app with enhanced EmailJS handling
    function initApp() {
        // ... your existing init code ...
        
        // Add local assignments viewer
        addLocalAssignmentsViewer();
        
        // Pre-initialize EmailJS (non-blocking)
        setTimeout(() => {
            initializeEmailJS().catch(error => {
                console.log('EmailJS initialization failed (non-critical)');
            });
        }, 2000);
    }

    // Update the admin panel to show local assignments
    document.addEventListener('DOMContentLoaded', function() {
        // Add this to your existing admin panel setup
        const adminSection = document.getElementById('adminSection');
        if (adminSection && gameState.isAdmin) {
            const localAssignmentsBtn = document.createElement('button');
            localAssignmentsBtn.className = 'btn btn-admin';
            localAssignmentsBtn.textContent = 'View Local Assignments';
            localAssignmentsBtn.onclick = viewLocalAssignments;
            adminSection.querySelector('.admin-controls').appendChild(localAssignmentsBtn);
        }
    });
</script>
